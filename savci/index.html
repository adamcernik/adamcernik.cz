<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Poznávačka savců</title>
    <style>
      :root {
        --bg: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --good: #16a34a;
        --bad: #dc2626;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: var(--bg);
        color: var(--text);
      }

      .wrap {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
        display: grid;
        gap: 12px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
      }

      h1 {
        font-size: 16px;
        margin: 0;
        font-weight: 650;
      }

      .stats {
        font-size: 13px;
        color: var(--muted);
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        display: grid;
        gap: 12px;
      }

      .imgWrap {
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        background: #fafafa;
        min-height: 240px;
        display: grid;
        place-items: center;
      }

      #animalImg {
        width: 100%;
        height: min(52vh, 520px);
        object-fit: contain;
        display: block;
      }

      @supports (height: 1svh) {
        #animalImg {
          height: min(52svh, 520px);
        }
      }

      .choices {
        display: grid;
        gap: 10px;
      }

      .level2 {
        display: none;
        gap: 10px;
      }

      .level2.show {
        display: grid;
      }

      .l2Row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      #l2Input {
        flex: 0 0 auto;
        width: 10ch;
        padding: 10px 12px;
        font-size: 44px;
        line-height: 1;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        border: 1px solid var(--border);
        border-radius: 12px;
        outline: none;
        font-variant-numeric: tabular-nums;
      }

      #l2Input:focus {
        box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.08);
      }

      .hint {
        font-size: 14px;
        color: var(--muted);
      }

      .reveal {
        font-size: 26px;
        font-weight: 700;
        letter-spacing: 0.01em;
      }

      .menu {
        display: grid;
        gap: 10px;
      }

      .menuTitle {
        font-size: 14px;
        color: var(--muted);
      }

      .level3 {
        display: none;
        gap: 12px;
      }

      .level3.show {
        display: grid;
      }

      .level4 {
        display: none;
        gap: 10px;
      }

      .level4.show {
        display: grid;
      }

      .l4Note {
        font-size: 13px;
        color: var(--muted);
      }

      .l3Note {
        font-size: 13px;
        color: var(--muted);
      }

      .memoryGrid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
      }

      .tile {
        position: relative;
        width: 100%;
        aspect-ratio: 1 / 1;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
        padding: 0;
        cursor: pointer;
        overflow: hidden;
      }

      .tile:disabled {
        cursor: default;
        opacity: 0.95;
      }

      .tile .front,
      .tile .back {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
      }

      .tile .back {
        background: linear-gradient(135deg, #f3f4f6, #ffffff);
        color: var(--muted);
        font-weight: 800;
        font-size: 22px;
        letter-spacing: 0.06em;
      }

      .tile .front {
        display: grid;
        grid-template-rows: 1fr auto;
        background: #fff;
      }

      .tile img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .tile .label {
        padding: 6px 8px;
        font-size: 11px;
        font-weight: 700;
        line-height: 1.1;
        border-top: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.94);
      }

      .tile[data-revealed="false"] .front {
        display: none;
      }

      .tile[data-revealed="true"] .back {
        display: none;
      }

      .tile.matched {
        border-color: rgba(22, 163, 74, 0.45);
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.12);
      }

      /* Roomier layout for the 6x6 grid */
      body.mode-level3 .wrap {
        max-width: 980px;
      }

      @media (max-width: 820px) {
        .memoryGrid {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      @media (max-width: 520px) {
        .memoryGrid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      button.choice {
        width: 100%;
        text-align: left;
        padding: 12px 12px;
        font-size: 16px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
      }

      button.choice:disabled {
        cursor: default;
      }

      button.choice.good {
        border-color: rgba(22, 163, 74, 0.45);
        background: rgba(22, 163, 74, 0.1);
      }

      button.choice.bad {
        border-color: rgba(220, 38, 38, 0.45);
        background: rgba(220, 38, 38, 0.1);
      }

      .msg {
        min-height: 20px;
        font-size: 14px;
        color: var(--muted);
      }

      .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 12px;
        font-size: 13px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
      }

      .end {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        display: none;
        color: var(--muted);
      }

      .end.show {
        display: block;
      }

      /* Mobile Level 2: keep image at the absolute top, stable height even with keyboard */
      @media (max-width: 520px) {
        body.mode-level2 .wrap {
          padding: 0;
          min-height: calc(var(--vvh, 1vh) * 100);
        }

        body.mode-level2 header {
          display: none;
        }

        body.mode-level2 #gameCard {
          border: 0;
          border-radius: 0;
          padding: 0;
        }

        body.mode-level2 .imgWrap {
          border: 0;
          border-radius: 0;
          min-height: 0;
        }

        body.mode-level2 #animalImg {
          /* Use visual viewport height so keyboard doesn't "push" the image off-screen */
          height: calc(var(--vvh, 1vh) * 50);
        }

        body.mode-level2 #level2Panel,
        body.mode-level2 #message,
        body.mode-level2 .controls,
        body.mode-level2 #endPanel {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Poznávačka savců</h1>
        <div class="stats">
          Skóre: <strong id="score">0</strong> · <span id="progress">0/0</span>
        </div>
      </header>

      <div class="card menu" id="menuCard">
        <div class="menuTitle">Vyber úroveň</div>
        <div class="controls">
          <button class="btn" id="level1Btn" type="button">Level 1 (výběr)</button>
          <button class="btn" id="level2Btn" type="button">Level 2 (3 písmena)</button>
          <button class="btn" id="level3Btn" type="button">Level 3 (pexeso)</button>
          <button class="btn" id="level4Btn" type="button">Level 4 (odhalení)</button>
        </div>
        <div class="msg" id="menuMessage"></div>
      </div>

      <div class="card" id="gameCard" style="display: none">
        <div class="imgWrap">
          <img id="animalImg" alt="Zvíře" />
        </div>

        <div class="choices" id="choices"></div>

        <div class="level2" id="level2Panel">
          <div class="l2Row">
            <input
              id="l2Input"
              inputmode="text"
              maxlength="3"
              autocomplete="off"
              autocapitalize="characters"
              spellcheck="false"
              aria-label="Napiš první tři písmena"
            />
            <button class="btn" id="l2OkBtn" type="button">OK</button>
            <button class="btn" id="l2HelpBtn" type="button">HELP</button>
          </div>
          <div class="hint" id="l2Hint"></div>
          <div class="reveal" id="l2Reveal" aria-live="polite"></div>
        </div>

        <div class="level3" id="level3Panel">
          <div class="l3Note">
            Klikni na 2 kartičky. Když jsou stejné, zůstanou otočené a máš bod.
          </div>
          <div class="memoryGrid" id="memoryGrid"></div>
        </div>

        <div class="level4" id="level4Panel">
          <div class="l4Note">
            Stiskni Enter pro odhalení názvu. Další Enter = další zvíře.
          </div>
          <div class="reveal" id="l4Reveal" aria-live="polite"></div>
        </div>

        <div class="msg" id="message"></div>

        <div class="controls">
          <button class="btn" id="backBtn" type="button">Výběr úrovně</button>
          <button class="btn" id="restartBtn" type="button">Restart</button>
          <button class="btn" id="skipBtn" type="button">Přeskočit</button>
          <button class="btn" id="fullscreenBtn" type="button">Fullscreen</button>
        </div>
      </div>

      <div class="end" id="endPanel"></div>
    </div>

    <script>
      const MANIFEST_URL = "animals_manifest.json";

      /** @type {{id:number, answer:string, image:string}[]} */
      let items = [];
      let mode = "menu"; // "menu" | "level1" | "level2"

      const l1 = {
        /** @type {{id:number, answer:string, image:string}[]} */ queue: [],
        score: 0,
        index: 0,
        locked: false,
        /** @type {{id:number, answer:string, image:string} | null} */ current: null,
      };

      const l2 = {
        /** @type {{id:number, answer:string, image:string}[]} */ queue: [],
        score: 0,
        index: 0,
        locked: false,
        helpUsed: 0,
        /** @type {{id:number, answer:string, image:string} | null} */ current: null,
      };

      const l3 = {
        /** @type {{id:number, answer:string, image:string}[]} */ picked: [],
        /** @type {{pairId:number, item:{id:number, answer:string, image:string}, revealed:boolean, matched:boolean}[]} */ tiles:
          [],
        score: 0,
        matchedPairs: 0,
        totalPairs: 18,
        locked: false,
        firstIdx: -1,
        secondIdx: -1,
        pendingMismatch: false,
        /** @type {number | null} */ mismatchTimer: null,
      };

      const l4 = {
        /** @type {{id:number, answer:string, image:string}[]} */ queue: [],
        score: 0,
        index: 0,
        revealed: false,
        /** @type {{id:number, answer:string, image:string} | null} */ current: null,
      };

      const $score = document.getElementById("score");
      const $progress = document.getElementById("progress");
      const $img = document.getElementById("animalImg");
      const $choices = document.getElementById("choices");
      const $msg = document.getElementById("message");
      const $end = document.getElementById("endPanel");
      const $menu = document.getElementById("menuCard");
      const $menuMsg = document.getElementById("menuMessage");
      const $game = document.getElementById("gameCard");
      const $l2Panel = document.getElementById("level2Panel");
      const $l2Input = document.getElementById("l2Input");
      const $l2Hint = document.getElementById("l2Hint");
      const $l2Reveal = document.getElementById("l2Reveal");
      const $l2HelpBtn = document.getElementById("l2HelpBtn");
      const $l2OkBtn = document.getElementById("l2OkBtn");
      const $l3Panel = document.getElementById("level3Panel");
      const $grid = document.getElementById("memoryGrid");
      const $l4Panel = document.getElementById("level4Panel");
      const $l4Reveal = document.getElementById("l4Reveal");
      const $fsBtn = document.getElementById("fullscreenBtn");

      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

      function shuffle(arr) {
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function sampleWrongAnswers(correct, count) {
        const pool = items.map((x) => x.answer).filter((a) => a !== correct);
        const picked = [];
        while (picked.length < count && pool.length) {
          const idx = Math.floor(Math.random() * pool.length);
          picked.push(pool[idx]);
          pool.splice(idx, 1);
        }
        return picked;
      }

      function encodePath(p) {
        return p
          .split("/")
          .map((seg) => encodeURIComponent(seg))
          .join("/");
      }

      function setMessage(text) {
        $msg.textContent = text || "";
      }

      function setMenuMessage(text) {
        $menuMsg.textContent = text || "";
      }

      function setEnd(show, text = "") {
        $end.classList.toggle("show", show);
        $end.textContent = text;
      }

      function clearChoices() {
        $choices.innerHTML = "";
      }

      function setProgressFrom(state) {
        $score.textContent = String(state.score);
        $progress.textContent = `${Math.min(state.index + 1, state.queue.length)}/${state.queue.length}`;
      }

      function normalizeText(s) {
        const str = String(s || "").toLowerCase();
        // Strip diacritics (works in modern browsers; falls back for older ones)
        try {
          return str.normalize("NFD").replace(/\p{Diacritic}/gu, "");
        } catch {
          return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
      }

      function getFirstWord(answer) {
        return String(answer || "").trim().split(/\s+/)[0] || "";
      }

      function l2TargetDisplay(item) {
        return getFirstWord(item.answer).slice(0, 3);
      }

      function l2TargetNorm(item) {
        return normalizeText(getFirstWord(item.answer)).slice(0, 3);
      }

      function renderL2Hint() {
        if (!l2.current) {
          $l2Hint.textContent = "";
          return;
        }
        const target = l2TargetDisplay(l2.current);
        const revealCount = Math.min(3, Math.max(0, l2.helpUsed));
        const shown =
          target.slice(0, revealCount) +
          "_".repeat(Math.max(0, 3 - revealCount));
        $l2Hint.textContent = `Nápověda: ${shown.split("").join(" ")}`;
      }

      function setMode(next) {
        mode = next;
        setEnd(false);
        setMessage("");
        setMenuMessage("");

        const inMenu = mode === "menu";
        $menu.style.display = inMenu ? "grid" : "none";
        $game.style.display = inMenu ? "none" : "grid";

        const isL1 = mode === "level1";
        const isL2 = mode === "level2";
        const isL3 = mode === "level3";
        const isL4 = mode === "level4";
        $choices.style.display = isL1 ? "grid" : "none";
        $l2Panel.classList.toggle("show", isL2);
        $l3Panel.classList.toggle("show", isL3);
        $l4Panel.classList.toggle("show", isL4);

        document.body.classList.toggle("mode-level2", isL2);
        document.body.classList.toggle("mode-level3", isL3);
        document.body.classList.toggle("mode-level4", isL4);
        updateViewportVars();

        // Skip button doesn't make sense for pexeso / Level 4 (Enter-driven)
        document.getElementById("skipBtn").style.display = isL3 || isL4 ? "none" : "";
      }

      function updateViewportVars() {
        // --vvh = 1% of the *visual* viewport (accounts for mobile keyboard)
        const vv = window.visualViewport;
        const h = vv && typeof vv.height === "number" ? vv.height : window.innerHeight;
        document.documentElement.style.setProperty("--vvh", `${h * 0.01}px`);
      }

      function updateFullscreenUi() {
        if (!$fsBtn) return;
        const supported =
          !!document.fullscreenEnabled ||
          // Safari iOS uses prefixed API on some versions
          !!document.webkitFullscreenEnabled;
        if (!supported) {
          $fsBtn.style.display = "none";
          return;
        }
        const active =
          !!document.fullscreenElement ||
          // Safari
          !!document.webkitFullscreenElement;
        $fsBtn.textContent = active ? "Exit fullscreen" : "Fullscreen";
      }

      async function toggleFullscreen() {
        const el = document.documentElement;
        const active =
          !!document.fullscreenElement || !!document.webkitFullscreenElement;
        try {
          if (active) {
            if (document.exitFullscreen) await document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
          } else {
            if (el.requestFullscreen) await el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
          }
        } finally {
          updateFullscreenUi();
        }
      }

      async function showCurrentLevel1() {
        l1.locked = false;
        setEnd(false);
        setMessage("");
        clearChoices();

        if (l1.index >= l1.queue.length) {
          setProgressFrom(l1);
          setEnd(true, `Hotovo! Skóre: ${l1.score} / ${l1.queue.length}.`);
          return;
        }

        l1.current = l1.queue[l1.index];
        setProgressFrom(l1);

        $img.src = encodePath(l1.current.image);
        $img.alt = `Zvíře ${l1.index + 1}`;

        const options = shuffle([
          l1.current.answer,
          ...sampleWrongAnswers(l1.current.answer, 2),
        ]);
        for (const opt of options) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "choice";
          btn.textContent = opt;
          btn.addEventListener("click", () => onPickLevel1(btn, opt));
          $choices.appendChild(btn);
        }
      }

      async function onPickLevel1(btn, picked) {
        if (l1.locked) return;
        l1.locked = true;

        const buttons = Array.from($choices.querySelectorAll("button.choice"));
        for (const b of buttons) b.disabled = true;

        const ok = picked === l1.current.answer;
        if (ok) {
          btn.classList.add("good");
          l1.score += 1;
          setMessage("Správně.");
          await sleep(350);
        } else {
          btn.classList.add("bad");
          const correctBtn = buttons.find(
            (b) => b.textContent === l1.current.answer
          );
          if (correctBtn) correctBtn.classList.add("good");
          setMessage(`Správně je: ${l1.current.answer}`);
          await sleep(2000);
        }

        l1.index += 1;
        await showCurrentLevel1();
      }

      async function showCurrentLevel2() {
        l2.locked = false;
        l2.helpUsed = 0;
        setEnd(false);
        setMessage("");
        clearChoices();

        if (l2.index >= l2.queue.length) {
          setProgressFrom(l2);
          setEnd(true, `Hotovo! Skóre: ${l2.score} / ${l2.queue.length}.`);
          return;
        }

        l2.current = l2.queue[l2.index];
        setProgressFrom(l2);

        $img.src = encodePath(l2.current.image);
        $img.alt = `Zvíře ${l2.index + 1}`;

        $l2Input.value = "";
        $l2HelpBtn.disabled = false;
        $l2Reveal.textContent = "";
        renderL2Hint();
        $l2Input.focus();
      }

      async function checkLevel2() {
        if (mode !== "level2") return;
        if (l2.locked) return;
        if (!l2.current) return;

        const guess = normalizeText($l2Input.value).trim();
        if (guess.length < 3) {
          setMessage("Napiš 3 písmena.");
          return;
        }

        const ok = guess.slice(0, 3) === l2TargetNorm(l2.current);
        if (!ok) {
          setMessage("To není ono. Zkus to znovu, nebo dej HELP.");
          return;
        }

        l2.locked = true;
        l2.score += 1;
        // Show the full name clearly before advancing (helps memorization)
        $l2Reveal.textContent = l2.current.answer;
        setMessage("Správně.");
        $l2Input.blur(); // hide keyboard so the image/name are visible
        await sleep(1600);
        l2.index += 1;
        await showCurrentLevel2();
      }

      function helpLevel2() {
        if (mode !== "level2") return;
        if (l2.locked) return;
        if (!l2.current) return;
        if (l2.helpUsed >= 3) return;

        l2.helpUsed += 1;
        const target = l2TargetDisplay(l2.current);
        $l2Input.value = target.slice(0, Math.min(3, l2.helpUsed));
        $l2HelpBtn.disabled = l2.helpUsed >= 3;
        renderL2Hint();
        $l2Input.focus();
      }

      function restartLevel1() {
        l1.score = 0;
        l1.index = 0;
        l1.queue = shuffle(items);
        showCurrentLevel1();
      }

      function restartLevel2() {
        l2.score = 0;
        l2.index = 0;
        l2.queue = shuffle(items);
        showCurrentLevel2();
      }

      function setProgressLevel3() {
        $score.textContent = String(l3.score);
        $progress.textContent = `${l3.matchedPairs}/${l3.totalPairs}`;
      }

      function renderLevel3() {
        $grid.innerHTML = "";
        for (let i = 0; i < l3.tiles.length; i++) {
          const t = l3.tiles[i];
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "tile" + (t.matched ? " matched" : "");
          btn.dataset.revealed = t.revealed || t.matched ? "true" : "false";
          btn.disabled = t.matched;
          btn.addEventListener("click", () => onPickLevel3(i));

          const back = document.createElement("div");
          back.className = "back";
          back.textContent = "SAVCI";

          const front = document.createElement("div");
          front.className = "front";

          const img = document.createElement("img");
          img.alt = t.item.answer;
          img.src = encodePath(t.item.image);

          const label = document.createElement("div");
          label.className = "label";
          label.textContent = t.item.answer;

          front.appendChild(img);
          front.appendChild(label);
          btn.appendChild(back);
          btn.appendChild(front);
          $grid.appendChild(btn);
        }
      }

      async function onPickLevel3(idx) {
        if (mode !== "level3") return;
        if (l3.pendingMismatch) return; // wait for outside click (or timer) to flip back
        if (l3.locked) return;
        const t = l3.tiles[idx];
        if (!t || t.matched || t.revealed) return;

        t.revealed = true;
        renderLevel3();

        if (l3.firstIdx === -1) {
          l3.firstIdx = idx;
          return;
        }

        l3.secondIdx = idx;
        const a = l3.tiles[l3.firstIdx];
        const b = l3.tiles[l3.secondIdx];
        if (!a || !b) return;

        const isMatch = a.pairId === b.pairId;
        if (isMatch) {
          a.matched = true;
          b.matched = true;
          l3.score += 1;
          l3.matchedPairs += 1;
          l3.firstIdx = -1;
          l3.secondIdx = -1;
          setMessage("Správně!");
          setProgressLevel3();
          renderLevel3();
          if (l3.matchedPairs >= l3.totalPairs) {
            setEnd(true, `Hotovo! Skóre: ${l3.score} / ${l3.totalPairs}.`);
          }
          return;
        }

        l3.locked = true;
        l3.pendingMismatch = true;
        setMessage("Nesedí. Klikni pro otočení zpět (nebo počkej 2 s).");
        // Auto-flip after 2s, but allow a click to flip earlier.
        l3.mismatchTimer = window.setTimeout(resolveMismatchLevel3, 2000);
      }

      function resolveMismatchLevel3() {
        if (!l3.pendingMismatch) return;
        if (l3.mismatchTimer != null) {
          clearTimeout(l3.mismatchTimer);
          l3.mismatchTimer = null;
        }
        const a = l3.tiles[l3.firstIdx];
        const b = l3.tiles[l3.secondIdx];
        if (a) a.revealed = false;
        if (b) b.revealed = false;
        l3.firstIdx = -1;
        l3.secondIdx = -1;
        l3.locked = false;
        l3.pendingMismatch = false;
        renderLevel3();
      }

      function restartLevel3() {
        l3.score = 0;
        l3.matchedPairs = 0;
        l3.locked = false;
        l3.firstIdx = -1;
        l3.secondIdx = -1;
        l3.pendingMismatch = false;
        if (l3.mismatchTimer != null) {
          clearTimeout(l3.mismatchTimer);
          l3.mismatchTimer = null;
        }
        setEnd(false);
        setMessage("");

        // Pick N unique animals, duplicate them into pairs, then shuffle.
        const picked = shuffle(items).slice(0, l3.totalPairs);
        l3.picked = picked;
        const tiles = [];
        for (let i = 0; i < picked.length; i++) {
          tiles.push({ pairId: i, item: picked[i], revealed: false, matched: false });
          tiles.push({ pairId: i, item: picked[i], revealed: false, matched: false });
        }
        l3.tiles = shuffle(tiles);

        // Image area isn't needed in Level 3; keep it empty.
        $img.removeAttribute("src");
        $img.alt = "Pexeso";

        setProgressLevel3();
        renderLevel3();
      }

      async function showCurrentLevel4() {
        setEnd(false);
        setMessage("");
        clearChoices();
        if ($l2Reveal) $l2Reveal.textContent = "";
        if ($l4Reveal) $l4Reveal.textContent = "";

        if (l4.index >= l4.queue.length) {
          setProgressFrom(l4);
          setEnd(true, `Hotovo! ${l4.queue.length} / ${l4.queue.length}.`);
          return;
        }

        l4.current = l4.queue[l4.index];
        l4.revealed = false;
        setProgressFrom(l4);

        $img.src = encodePath(l4.current.image);
        $img.alt = `Zvíře ${l4.index + 1}`;
      }

      async function toggleRevealOrNextLevel4() {
        if (mode !== "level4") return;
        if (!l4.current) return;

        if (!l4.revealed) {
          l4.revealed = true;
          $l4Reveal.textContent = l4.current.answer;
          return;
        }

        // Next
        l4.index += 1;
        await showCurrentLevel4();
      }

      function restartLevel4() {
        l4.score = 0;
        l4.index = 0;
        l4.queue = shuffle(items);
        l4.current = null;
        l4.revealed = false;
        showCurrentLevel4();
      }

      function restart() {
        if (mode === "level1") restartLevel1();
        if (mode === "level2") restartLevel2();
        if (mode === "level3") restartLevel3();
        if (mode === "level4") restartLevel4();
      }

      async function init() {
        try {
          updateViewportVars();
          window.addEventListener("resize", updateViewportVars);
          if (window.visualViewport) {
            window.visualViewport.addEventListener("resize", updateViewportVars);
            window.visualViewport.addEventListener("scroll", updateViewportVars);
          }
          updateFullscreenUi();
          document.addEventListener("fullscreenchange", updateFullscreenUi);
          document.addEventListener("webkitfullscreenchange", updateFullscreenUi);
          // Level 3: allow flipping mismatched cards back early, but ONLY by clicking outside the board.
          document.addEventListener(
            "click",
            (e) => {
              if (mode !== "level3") return;
              if (!l3.pendingMismatch) return;
              if ($grid && $grid.contains(e.target)) return;
              resolveMismatchLevel3();
            },
            true
          );

          const res = await fetch(MANIFEST_URL, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          items = Array.isArray(data.items) ? data.items : [];
          if (items.length < 3) throw new Error("Moc málo zvířat v manifestu.");
          setMode("menu");
          setProgressFrom({ score: 0, index: 0, queue: items });
          setMenuMessage("Tip: Level 2 chce první 3 písmena prvního slova názvu.");
        } catch (e) {
          setMode("menu");
          setMenuMessage(`Nelze načíst data. Spusť stránku přes server. (${e.message})`);
          clearChoices();
        }
      }

      document.getElementById("level1Btn").addEventListener("click", () => {
        if (!items.length) return;
        setMode("level1");
        restartLevel1();
      });

      document.getElementById("level2Btn").addEventListener("click", () => {
        if (!items.length) return;
        setMode("level2");
        restartLevel2();
      });

      document.getElementById("level3Btn").addEventListener("click", () => {
        if (!items.length) return;
        setMode("level3");
        restartLevel3();
      });

      document.getElementById("level4Btn").addEventListener("click", () => {
        if (!items.length) return;
        setMode("level4");
        restartLevel4();
      });

      document.getElementById("backBtn").addEventListener("click", () => {
        setMode("menu");
        setProgressFrom({ score: 0, index: 0, queue: items });
      });

      document.getElementById("restartBtn").addEventListener("click", restart);
      document.getElementById("skipBtn").addEventListener("click", async () => {
        if (mode === "level1") {
          if (l1.locked) return;
          l1.locked = true;
          l1.index += 1;
          await showCurrentLevel1();
          return;
        }
        if (mode === "level2") {
          if (l2.locked) return;
          l2.locked = true;
          l2.index += 1;
          await showCurrentLevel2();
        }
      });

      $l2HelpBtn.addEventListener("click", helpLevel2);
      $l2OkBtn.addEventListener("click", checkLevel2);
      $fsBtn.addEventListener("click", toggleFullscreen);
      $l2Input.addEventListener("input", () => {
        if (mode !== "level2") return;
        // keep only letters/spaces, limit to 3, auto-check when ready
        const v = String($l2Input.value || "");
        const cleaned = v.replace(/[^a-zA-ZáéěíóúůýčďňřšťžÁÉĚÍÓÚŮÝČĎŇŘŠŤŽ]/g, "");
        if (cleaned !== v) $l2Input.value = cleaned;
        if ($l2Input.value.length >= 3) checkLevel2();
      });

      $l2Input.addEventListener("keydown", (e) => {
        if (mode !== "level2") return;
        if (e.key === "Enter") {
          e.preventDefault();
          checkLevel2();
        }
      });

      document.addEventListener("keydown", (e) => {
        if (mode !== "level4") return;
        // Avoid interfering if focus is inside an input elsewhere
        const el = document.activeElement;
        if (el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA")) return;
        if (e.key === "Enter") {
          e.preventDefault();
          toggleRevealOrNextLevel4();
        }
      });

      init();
    </script>
  </body>
</html>


