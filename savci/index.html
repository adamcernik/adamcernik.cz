<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Poznávačka savců</title>
    <style>
      :root {
        --bg: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --good: #16a34a;
        --bad: #dc2626;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: var(--bg);
        color: var(--text);
      }

      .wrap {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
        display: grid;
        gap: 12px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
      }

      h1 {
        font-size: 16px;
        margin: 0;
        font-weight: 650;
      }

      .stats {
        font-size: 13px;
        color: var(--muted);
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        display: grid;
        gap: 12px;
      }

      .imgWrap {
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        background: #fafafa;
        min-height: 240px;
        display: grid;
        place-items: center;
      }

      #animalImg {
        width: 100%;
        height: min(52vh, 520px);
        object-fit: contain;
        display: block;
      }

      @supports (height: 1svh) {
        #animalImg {
          height: min(52svh, 520px);
        }
      }

      .choices {
        display: grid;
        gap: 10px;
      }

      .level2 {
        display: none;
        gap: 10px;
      }

      .level2.show {
        display: grid;
      }

      .l2Row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      #l2Input {
        flex: 0 0 auto;
        width: 10ch;
        padding: 10px 12px;
        font-size: 44px;
        line-height: 1;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        border: 1px solid var(--border);
        border-radius: 12px;
        outline: none;
        font-variant-numeric: tabular-nums;
      }

      #l2Input:focus {
        box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.08);
      }

      .hint {
        font-size: 14px;
        color: var(--muted);
      }

      .reveal {
        font-size: 26px;
        font-weight: 700;
        letter-spacing: 0.01em;
      }

      .menu {
        display: grid;
        gap: 10px;
      }

      .menuTitle {
        font-size: 14px;
        color: var(--muted);
      }

      button.choice {
        width: 100%;
        text-align: left;
        padding: 12px 12px;
        font-size: 16px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
      }

      button.choice:disabled {
        cursor: default;
      }

      button.choice.good {
        border-color: rgba(22, 163, 74, 0.45);
        background: rgba(22, 163, 74, 0.1);
      }

      button.choice.bad {
        border-color: rgba(220, 38, 38, 0.45);
        background: rgba(220, 38, 38, 0.1);
      }

      .msg {
        min-height: 20px;
        font-size: 14px;
        color: var(--muted);
      }

      .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 12px;
        font-size: 13px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
      }

      .end {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        display: none;
        color: var(--muted);
      }

      .end.show {
        display: block;
      }

      /* Mobile Level 2: keep image at the absolute top, stable height even with keyboard */
      @media (max-width: 520px) {
        body.mode-level2 .wrap {
          padding: 0;
          min-height: calc(var(--vvh, 1vh) * 100);
        }

        body.mode-level2 header {
          display: none;
        }

        body.mode-level2 #gameCard {
          border: 0;
          border-radius: 0;
          padding: 0;
        }

        body.mode-level2 .imgWrap {
          border: 0;
          border-radius: 0;
          min-height: 0;
        }

        body.mode-level2 #animalImg {
          /* Use visual viewport height so keyboard doesn't "push" the image off-screen */
          height: calc(var(--vvh, 1vh) * 50);
        }

        body.mode-level2 #level2Panel,
        body.mode-level2 #message,
        body.mode-level2 .controls,
        body.mode-level2 #endPanel {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Poznávačka savců</h1>
        <div class="stats">
          Skóre: <strong id="score">0</strong> · <span id="progress">0/0</span>
        </div>
      </header>

      <div class="card menu" id="menuCard">
        <div class="menuTitle">Vyber úroveň</div>
        <div class="controls">
          <button class="btn" id="level1Btn" type="button">Level 1 (výběr)</button>
          <button class="btn" id="level2Btn" type="button">Level 2 (3 písmena)</button>
        </div>
        <div class="msg" id="menuMessage"></div>
      </div>

      <div class="card" id="gameCard" style="display: none">
        <div class="imgWrap">
          <img id="animalImg" alt="Zvíře" />
        </div>

        <div class="choices" id="choices"></div>

        <div class="level2" id="level2Panel">
          <div class="l2Row">
            <input
              id="l2Input"
              inputmode="text"
              maxlength="3"
              autocomplete="off"
              autocapitalize="characters"
              spellcheck="false"
              aria-label="Napiš první tři písmena"
            />
            <button class="btn" id="l2OkBtn" type="button">OK</button>
            <button class="btn" id="l2HelpBtn" type="button">HELP</button>
          </div>
          <div class="hint" id="l2Hint"></div>
          <div class="reveal" id="l2Reveal" aria-live="polite"></div>
        </div>

        <div class="msg" id="message"></div>

        <div class="controls">
          <button class="btn" id="backBtn" type="button">Výběr úrovně</button>
          <button class="btn" id="restartBtn" type="button">Restart</button>
          <button class="btn" id="skipBtn" type="button">Přeskočit</button>
        </div>
      </div>

      <div class="end" id="endPanel"></div>
    </div>

    <script>
      const MANIFEST_URL = "animals_manifest.json";

      /** @type {{id:number, answer:string, image:string}[]} */
      let items = [];
      let mode = "menu"; // "menu" | "level1" | "level2"

      const l1 = {
        /** @type {{id:number, answer:string, image:string}[]} */ queue: [],
        score: 0,
        index: 0,
        locked: false,
        /** @type {{id:number, answer:string, image:string} | null} */ current: null,
      };

      const l2 = {
        /** @type {{id:number, answer:string, image:string}[]} */ queue: [],
        score: 0,
        index: 0,
        locked: false,
        helpUsed: 0,
        /** @type {{id:number, answer:string, image:string} | null} */ current: null,
      };

      const $score = document.getElementById("score");
      const $progress = document.getElementById("progress");
      const $img = document.getElementById("animalImg");
      const $choices = document.getElementById("choices");
      const $msg = document.getElementById("message");
      const $end = document.getElementById("endPanel");
      const $menu = document.getElementById("menuCard");
      const $menuMsg = document.getElementById("menuMessage");
      const $game = document.getElementById("gameCard");
      const $l2Panel = document.getElementById("level2Panel");
      const $l2Input = document.getElementById("l2Input");
      const $l2Hint = document.getElementById("l2Hint");
      const $l2Reveal = document.getElementById("l2Reveal");
      const $l2HelpBtn = document.getElementById("l2HelpBtn");
      const $l2OkBtn = document.getElementById("l2OkBtn");

      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

      function shuffle(arr) {
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function sampleWrongAnswers(correct, count) {
        const pool = items.map((x) => x.answer).filter((a) => a !== correct);
        const picked = [];
        while (picked.length < count && pool.length) {
          const idx = Math.floor(Math.random() * pool.length);
          picked.push(pool[idx]);
          pool.splice(idx, 1);
        }
        return picked;
      }

      function encodePath(p) {
        return p
          .split("/")
          .map((seg) => encodeURIComponent(seg))
          .join("/");
      }

      function setMessage(text) {
        $msg.textContent = text || "";
      }

      function setMenuMessage(text) {
        $menuMsg.textContent = text || "";
      }

      function setEnd(show, text = "") {
        $end.classList.toggle("show", show);
        $end.textContent = text;
      }

      function clearChoices() {
        $choices.innerHTML = "";
      }

      function setProgressFrom(state) {
        $score.textContent = String(state.score);
        $progress.textContent = `${Math.min(state.index + 1, state.queue.length)}/${state.queue.length}`;
      }

      function normalizeText(s) {
        const str = String(s || "").toLowerCase();
        // Strip diacritics (works in modern browsers; falls back for older ones)
        try {
          return str.normalize("NFD").replace(/\p{Diacritic}/gu, "");
        } catch {
          return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
      }

      function getFirstWord(answer) {
        return String(answer || "").trim().split(/\s+/)[0] || "";
      }

      function l2TargetDisplay(item) {
        return getFirstWord(item.answer).slice(0, 3);
      }

      function l2TargetNorm(item) {
        return normalizeText(getFirstWord(item.answer)).slice(0, 3);
      }

      function renderL2Hint() {
        if (!l2.current) {
          $l2Hint.textContent = "";
          return;
        }
        const target = l2TargetDisplay(l2.current);
        const revealCount = Math.min(3, Math.max(0, l2.helpUsed));
        const shown =
          target.slice(0, revealCount) +
          "_".repeat(Math.max(0, 3 - revealCount));
        $l2Hint.textContent = `Nápověda: ${shown.split("").join(" ")}`;
      }

      function setMode(next) {
        mode = next;
        setEnd(false);
        setMessage("");
        setMenuMessage("");

        const inMenu = mode === "menu";
        $menu.style.display = inMenu ? "grid" : "none";
        $game.style.display = inMenu ? "none" : "grid";

        const isL1 = mode === "level1";
        const isL2 = mode === "level2";
        $choices.style.display = isL1 ? "grid" : "none";
        $l2Panel.classList.toggle("show", isL2);

        document.body.classList.toggle("mode-level2", isL2);
        updateViewportVars();
      }

      function updateViewportVars() {
        // --vvh = 1% of the *visual* viewport (accounts for mobile keyboard)
        const vv = window.visualViewport;
        const h = vv && typeof vv.height === "number" ? vv.height : window.innerHeight;
        document.documentElement.style.setProperty("--vvh", `${h * 0.01}px`);
      }

      async function showCurrentLevel1() {
        l1.locked = false;
        setEnd(false);
        setMessage("");
        clearChoices();

        if (l1.index >= l1.queue.length) {
          setProgressFrom(l1);
          setEnd(true, `Hotovo! Skóre: ${l1.score} / ${l1.queue.length}.`);
          return;
        }

        l1.current = l1.queue[l1.index];
        setProgressFrom(l1);

        $img.src = encodePath(l1.current.image);
        $img.alt = `Zvíře ${l1.index + 1}`;

        const options = shuffle([
          l1.current.answer,
          ...sampleWrongAnswers(l1.current.answer, 2),
        ]);
        for (const opt of options) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "choice";
          btn.textContent = opt;
          btn.addEventListener("click", () => onPickLevel1(btn, opt));
          $choices.appendChild(btn);
        }
      }

      async function onPickLevel1(btn, picked) {
        if (l1.locked) return;
        l1.locked = true;

        const buttons = Array.from($choices.querySelectorAll("button.choice"));
        for (const b of buttons) b.disabled = true;

        const ok = picked === l1.current.answer;
        if (ok) {
          btn.classList.add("good");
          l1.score += 1;
          setMessage("Správně.");
          await sleep(350);
        } else {
          btn.classList.add("bad");
          const correctBtn = buttons.find(
            (b) => b.textContent === l1.current.answer
          );
          if (correctBtn) correctBtn.classList.add("good");
          setMessage(`Správně je: ${l1.current.answer}`);
          await sleep(2000);
        }

        l1.index += 1;
        await showCurrentLevel1();
      }

      async function showCurrentLevel2() {
        l2.locked = false;
        l2.helpUsed = 0;
        setEnd(false);
        setMessage("");
        clearChoices();

        if (l2.index >= l2.queue.length) {
          setProgressFrom(l2);
          setEnd(true, `Hotovo! Skóre: ${l2.score} / ${l2.queue.length}.`);
          return;
        }

        l2.current = l2.queue[l2.index];
        setProgressFrom(l2);

        $img.src = encodePath(l2.current.image);
        $img.alt = `Zvíře ${l2.index + 1}`;

        $l2Input.value = "";
        $l2HelpBtn.disabled = false;
        $l2Reveal.textContent = "";
        renderL2Hint();
        $l2Input.focus();
      }

      async function checkLevel2() {
        if (mode !== "level2") return;
        if (l2.locked) return;
        if (!l2.current) return;

        const guess = normalizeText($l2Input.value).trim();
        if (guess.length < 3) {
          setMessage("Napiš 3 písmena.");
          return;
        }

        const ok = guess.slice(0, 3) === l2TargetNorm(l2.current);
        if (!ok) {
          setMessage("To není ono. Zkus to znovu, nebo dej HELP.");
          return;
        }

        l2.locked = true;
        l2.score += 1;
        // Show the full name clearly before advancing (helps memorization)
        $l2Reveal.textContent = l2.current.answer;
        setMessage("Správně.");
        $l2Input.blur(); // hide keyboard so the image/name are visible
        await sleep(1600);
        l2.index += 1;
        await showCurrentLevel2();
      }

      function helpLevel2() {
        if (mode !== "level2") return;
        if (l2.locked) return;
        if (!l2.current) return;
        if (l2.helpUsed >= 3) return;

        l2.helpUsed += 1;
        const target = l2TargetDisplay(l2.current);
        $l2Input.value = target.slice(0, Math.min(3, l2.helpUsed));
        $l2HelpBtn.disabled = l2.helpUsed >= 3;
        renderL2Hint();
        $l2Input.focus();
      }

      function restartLevel1() {
        l1.score = 0;
        l1.index = 0;
        l1.queue = shuffle(items);
        showCurrentLevel1();
      }

      function restartLevel2() {
        l2.score = 0;
        l2.index = 0;
        l2.queue = shuffle(items);
        showCurrentLevel2();
      }

      function restart() {
        if (mode === "level1") restartLevel1();
        if (mode === "level2") restartLevel2();
      }

      async function init() {
        try {
          updateViewportVars();
          window.addEventListener("resize", updateViewportVars);
          if (window.visualViewport) {
            window.visualViewport.addEventListener("resize", updateViewportVars);
            window.visualViewport.addEventListener("scroll", updateViewportVars);
          }

          const res = await fetch(MANIFEST_URL, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          items = Array.isArray(data.items) ? data.items : [];
          if (items.length < 3) throw new Error("Moc málo zvířat v manifestu.");
          setMode("menu");
          setProgressFrom({ score: 0, index: 0, queue: items });
          setMenuMessage("Tip: Level 2 chce první 3 písmena prvního slova názvu.");
        } catch (e) {
          setMode("menu");
          setMenuMessage(`Nelze načíst data. Spusť stránku přes server. (${e.message})`);
          clearChoices();
        }
      }

      document.getElementById("level1Btn").addEventListener("click", () => {
        if (!items.length) return;
        setMode("level1");
        restartLevel1();
      });

      document.getElementById("level2Btn").addEventListener("click", () => {
        if (!items.length) return;
        setMode("level2");
        restartLevel2();
      });

      document.getElementById("backBtn").addEventListener("click", () => {
        setMode("menu");
        setProgressFrom({ score: 0, index: 0, queue: items });
      });

      document.getElementById("restartBtn").addEventListener("click", restart);
      document.getElementById("skipBtn").addEventListener("click", async () => {
        if (mode === "level1") {
          if (l1.locked) return;
          l1.locked = true;
          l1.index += 1;
          await showCurrentLevel1();
          return;
        }
        if (mode === "level2") {
          if (l2.locked) return;
          l2.locked = true;
          l2.index += 1;
          await showCurrentLevel2();
        }
      });

      $l2HelpBtn.addEventListener("click", helpLevel2);
      $l2OkBtn.addEventListener("click", checkLevel2);
      $l2Input.addEventListener("input", () => {
        if (mode !== "level2") return;
        // keep only letters/spaces, limit to 3, auto-check when ready
        const v = String($l2Input.value || "");
        const cleaned = v.replace(/[^a-zA-ZáéěíóúůýčďňřšťžÁÉĚÍÓÚŮÝČĎŇŘŠŤŽ]/g, "");
        if (cleaned !== v) $l2Input.value = cleaned;
        if ($l2Input.value.length >= 3) checkLevel2();
      });

      $l2Input.addEventListener("keydown", (e) => {
        if (mode !== "level2") return;
        if (e.key === "Enter") {
          e.preventDefault();
          checkLevel2();
        }
      });

      init();
    </script>
  </body>
</html>


